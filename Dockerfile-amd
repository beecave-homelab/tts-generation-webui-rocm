#################################################
############### SETUP PYTHON3.10  ###############
#################################################
FROM rocm/pytorch:rocm6.1.1_ubuntu22.04_py3.10_pytorch_release-2.1.2 AS rocm-pytorch

# Install necessary packages
RUN apt-get update -y && DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
    git nano curl sudo libelf1 libnuma-dev build-essential git software-properties-common gcc g++ ffmpeg \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

####################################################    
############# SETUP VIRTUALVENV & TTS ##############
####################################################    
FROM rocm-pytorch AS TTS-webui

# Install Node.Js
ENV NODE_VERSION=18.16.1
RUN curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
ENV NVM_DIR=/root/.nvm
RUN . "$NVM_DIR/nvm.sh" \
    && nvm install ${NODE_VERSION}
RUN . "$NVM_DIR/nvm.sh" \
    && nvm use v${NODE_VERSION}
RUN . "$NVM_DIR/nvm.sh" \
    && nvm alias default v${NODE_VERSION}
ENV PATH="$NVM_DIR/versions/node/v${NODE_VERSION}/bin/:${PATH}"
RUN node --version \
    && npm --version

# Set working directory for TTS-Generation-WebUI
# Clone the TTS-Generation-WebUI repository
# Set working directory to the cloned repo
# Install all requirements
WORKDIR /root/app
RUN git clone https://github.com/beecave-homelab/tts-generation-webui-rocm.git
WORKDIR /root/app/tts-generation-webui-rocm

EXPOSE 3000
CMD python3 check_cuda.py