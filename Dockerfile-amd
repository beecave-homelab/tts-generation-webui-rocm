####################################################    
########### SETUP PYTORCH AND LOCAL USER ###########
####################################################
FROM rocm/dev-ubuntu-22.04:6.1.1-complete AS rocm-pytorch

# Set arguments
ARG ROCM_VERSION=6.0
ARG AMDGPU_VERSION=6.0
ARG TORCH_VERSION=2.3.0

# Install necessary packages
RUN apt-get update -y && DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
    git nano curl sudo libelf1 libnuma-dev build-essential git software-properties-common gcc g++ ffmpeg \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Copy sudoers file for passwordless sudo
# Create rocm-user
# Set environment variables and switch to rocm-user
COPY sudo-nopasswd /etc/sudoers.d/sudo-nopasswd
RUN useradd --create-home -G sudo,video --shell /bin/bash rocm-user
USER rocm-user
WORKDIR /home/rocm-user
ENV PATH="${PATH}:/opt/rocm/bin"

# Install python3.10 and setup pytorch
RUN sudo apt-get update -y \
    && sudo add-apt-repository ppa:deadsnakes/ppa \
    && sudo apt-get update -y \
    && sudo apt-get install python3.10 python3.10-venv python3.10-dev \
    && sudo rm /usr/bin/python3 \
    && sudo ln -s python3.10 /usr/bin/python3 \
    && sudo ln -s python3.10 /usr/bin/python \
    && curl -sS https://bootstrap.pypa.io/get-pip.py | python3.10

ENV PATH="${PATH}:/home/rocm-user/.local/bin"
RUN pip3 install --upgrade pip wheel \
    && pip3 install torch==${TORCH_VERSION} torchaudio==${TORCH_VERSION} --index-url https://download.pytorch.org/whl/rocm${ROCM_VERSION} --no-cache-dir \
    && sudo apt-get clean \
    && sudo rm -rf /var/lib/apt-get/lists/*

####################################################    
############# SETUP VIRTUALVENV & TTS ##############
####################################################    
FROM rocm-pytorch AS TTS-webui

USER root
WORKDIR /root

# Install Node.Js
ENV NODE_VERSION=18.16.1
RUN curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | sudo bash
ENV NVM_DIR=/root/.nvm
RUN . "$NVM_DIR/nvm.sh" && nvm install ${NODE_VERSION}
RUN . "$NVM_DIR/nvm.sh" && nvm use v${NODE_VERSION}
RUN . "$NVM_DIR/nvm.sh" && nvm alias default v${NODE_VERSION}
ENV PATH="$NVM_DIR/versions/node/v${NODE_VERSION}/bin/:${PATH}"
RUN node --version
RUN npm --version

# Set working directory for TTS-Generation-WebUI
# Clone the TTS-Generation-WebUI repository
# Set working directory to the cloned repo
# Install all requirements
USER rocm-user
WORKDIR /home/rocm-user/app
RUN git clone https://github.com/beecave-homelab/tts-generation-webui-rocm.git
WORKDIR /home/rocm-user/app/tts-generation-webui-rocm

EXPOSE 3000
CMD python3 check_cuda.py