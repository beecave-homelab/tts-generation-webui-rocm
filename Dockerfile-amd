######################################################
### SETUP FOR AMD GPU DOCKER IMAGE ON UBUNTU 22.04 ###
######################################################
FROM ubuntu:22.04 AS rocm

# Set arguments
ARG ROCM_VERSION=6.1.1
ARG AMDGPU_VERSION=6.1.1
ARG TORCH_VERSION=2.3.0

# Install necessary packages and add ROCm and AMDGPU repositories
RUN apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
    ca-certificates curl gnupg \
    && mkdir --parents --mode=0755 /etc/apt/keyrings \
    && wget https://repo.radeon.com/rocm/rocm.gpg.key -O - | gpg --dearmor \
    | tee /etc/apt/keyrings/rocm.gpg > /dev/null \
    && echo "deb [arch=amd64 signed-by=/etc/apt/keyrings/rocm.gpg] https://repo.radeon.com/amdgpu/${AMDGPU_VERSION}/ubuntu jammy main" \
    | tee /etc/apt/sources.list.d/amdgpu.list \
    && apt update -y \
    && echo "deb [arch=amd64 signed-by=/etc/apt/keyrings/rocm.gpg] https://repo.radeon.com/rocm/apt/${AMDGPU_VERSION} jammy main" \
    | tee --append /etc/apt/sources.list.d/rocm.list \
    && echo -e 'Package: *\nPin: release o=repo.radeon.com\nPin-Priority: 600' \
    | tee /etc/apt/preferences.d/rocm-pin-600 \
    && apt update -y \
    && apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
    sudo libelf1 libnuma-dev build-essential git vim-nox cmake-curses-gui kmod file python3 python3-pip rocm-dev \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

####################################################    
########### SETUP PYTORCH AND LOCAL USER ###########
####################################################
FROM rocm AS rocm-pytorch

# Copy sudoers file for passwordless sudo
# Create rocm-user
# Set environment variables and switch to rocm-user
COPY sudo-nopasswd /etc/sudoers.d/sudo-nopasswd
RUN useradd --create-home -G sudo,video --shell /bin/bash rocm-user
USER rocm-user
WORKDIR /home/rocm-user
ENV PATH="${PATH}:/opt/rocm/bin"

# Install and setup pytorch
RUN sudo apt install python3.10 python3-pip -y \
    && pip3 install --upgrade pip wheel \
    && pip3 install torch==${TORCH_VERSION} torchaudio==${TORCH_VERSION} --index-url https://download.pytorch.org/whl/rocm${ROCM_VERSION}